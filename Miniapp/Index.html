<!doctype html><html><head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
  <title>Meme Bot</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#0b0c0f;color:#fff;font:16px system-ui}
    #app{min-height:100vh;padding-bottom:84px}
    header{position:sticky;top:0;padding:16px;background:#0b0c0f}
    .row{display:flex;align-items:center;gap:12px}
    .connect,.btn{border:0;border-radius:14px;padding:12px 16px;font-weight:700}
    .connect{margin-left:auto;background:#2ea6ff;color:#000}
    .muted{color:#9aa0a6}
    canvas{width:100%;height:140px;background:rgba(255,255,255,.06);border-radius:16px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 16px}
    .qty{margin:16px;background:rgba(255,255,255,.06);padding:12px;border-radius:16px}
    .qty input{width:100%;font-size:22px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:transparent;color:#fff}
    nav{position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:linear-gradient(180deg,transparent,#0b0c0f 40%);display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buy{background:#2ea6ff;color:#000}.sell{background:#ff3b30}
  </style>
</head><body><div id="app">
  <header><div class="row">
    <div><strong id="sym">TOKEN</strong><div id="price" class="muted">—</div></div>
    <button id="connect" class="connect">Connect Phantom</button>
  </div></header>
  <main>
    <div style="padding:0 16px"><canvas id="spark" width="600" height="200"></canvas></div>
    <div class="stats">
      <div><div class="muted">24h</div><div id="chg">—</div></div>
      <div><div class="muted">Liquidity</div><div id="liq">—</div></div>
      <div><div class="muted">FDV</div><div id="fdv">—</div></div>
    </div>
    <div class="qty">
      <label class="muted">Amount</label>
      <input id="amt" type="number" inputmode="decimal" placeholder="0.0"/>
    </div>
  </main>
  <nav>
    <button id="buy" class="btn buy">Buy</button>
    <button id="sell" class="btn sell">Sell</button>
  </nav>
</div>
<script type="module">
const tg = window.Telegram?.WebApp; tg?.expand();

// —— CONFIG: replace these with your real token/pair ——
const CHAIN = 'solana';
const PAIR  = '9jy4uky46rc2uh535ihtfzmzeaaxmbzs1z9t5p5a189e'; // dexscreener pair address
const INPUT_MINT = 'So11111111111111111111111111111111111111112'; // SOL
const OUTPUT_MINT = '4FK7J52ZPMXGGn9E5Vf7mkKru5EM59eyESApBbRN76nK'; // your token mint
const SLIPPAGE_BPS = 100; // 1%
// ————————————————————————————————————————————————

const els = {
  price: document.getElementById('price'),
  chg: document.getElementById('chg'),
  liq: document.getElementById('liq'),
  fdv: document.getElementById('fdv'),
  amt: document.getElementById('amt'),
  buy: document.getElementById('buy'),
  sell: document.getElementById('sell'),
  connect: document.getElementById('connect'),
  spark: document.getElementById('spark')
};

let userPubkey = localStorage.getItem('ph_user');
function short(pk){ return pk.slice(0,4)+'…'+pk.slice(-4); }
function uiConnected(){ document.getElementById('sym').textContent = `TOKEN · ${short(userPubkey)}`; els.connect.style.display='none'; }

// Simplified connect → Phantom opens and returns to this URL
function buildConnectLink(){
  const appUrl = encodeURIComponent(location.href.split('#')[0].split('?')[0]);
  return `https://phantom.app/ul/v1/connect?app_url=${appUrl}&cluster=mainnet-beta`;
}
function handleConnectReturn(){
  const p=new URLSearchParams(location.search);
  const data=p.get('data'); // simple connect payload
  if(data){ try{
    const j = JSON.parse(atob(data));
    if (j.public_key) { userPubkey = j.public_key; localStorage.setItem('ph_user', userPubkey); history.replaceState({},'',location.pathname); uiConnected(); }
  }catch{}}
}
handleConnectReturn();
if (userPubkey) uiConnected();

els.connect.onclick=()=>{ const link=buildConnectLink(); tg?.openLink? tg.openLink(link):location.href=link; };

// Live price sparkline (DexScreener polling)
const prices=[];
function draw(){
  const c=els.spark.getContext('2d'), w=els.spark.width=els.spark.clientWidth*devicePixelRatio, h=els.spark.height=els.spark.clientHeight*devicePixelRatio;
  c.clearRect(0,0,w,h); if(prices.length<2) return;
  const min=Math.min(...prices), max=Math.max(...prices);
  c.lineWidth=3*devicePixelRatio; c.beginPath();
  prices.forEach((p,i)=>{ const x=(i/(prices.length-1))*(w-8)+4; const y=h-4-((p-min)/(max-min||1))*(h-8); i?c.lineTo(x,y):c.moveTo(x,y); });
  c.stroke();
}
async function poll(){
  try{
    const r=await fetch(`/api/market/${CHAIN}/${PAIR}`); const j=await r.json(); const pair=j?.pairs?.[0];
    if(!pair) return; const price=Number(pair.priceUsd||pair.priceNative||0); if(!(price>0)) return;
    prices.push(price); if(prices.length>60) prices.shift(); draw();
    els.price.textContent=`$${price.toFixed(6)}`;
    els.chg.textContent=`${Number(pair.priceChange?.h24||0).toFixed(2)}%`;
    els.liq.textContent=`$${Math.round(pair.liquidity?.usd||0).toLocaleString()}`;
    els.fdv.textContent=`$${Math.round(pair.fdv||0).toLocaleString()}`;
  }catch{}
}
setInterval(poll, 5000); poll();

// One-tap buy/sell: server returns Phantom signAndSend deeplink
async function swap(side){
  if(!userPubkey){ tg?.showAlert?.('Connect Phantom first'); return; }
  const v = Number(els.amt.value||'0'); if(!(v>0)) return;
  const amountBase = Math.round(v*1e9); // adjust for token decimals
  const body = side==='buy'
    ? { inputMint: INPUT_MINT, outputMint: OUTPUT_MINT, amount: amountBase, slippageBps: SLIPPAGE_BPS, userPubkey }
    : { inputMint: OUTPUT_MINT, outputMint: INPUT_MINT, amount: amountBase, slippageBps: SLIPPAGE_BPS, userPubkey };
  const r = await fetch('/api/swap',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const { deeplink, error } = await r.json(); if(error) return tg?.showAlert?.(error);
  tg?.HapticFeedback?.impactOccurred?.('light');
  tg?.openLink? tg.openLink(deeplink):location.href=deeplink;
}
els.buy.onclick=()=>swap('buy'); els.sell.onclick=()=>swap('sell');
</script>
</body></html>
